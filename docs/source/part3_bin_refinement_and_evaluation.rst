Part 3: Bin Refinement with DAStool and Evaluation
==================================================

Overview
--------

In this part, you will refine the bins generated by the different binners using DAStool. DAStool integrates binning results from multiple tools to produce higher-quality bins. You will also assess the quality of bins from all binners and the refiner using CheckM2.

Task 1: Prepare DAStool Input
-----------------------------

**Step 1: Organize Binning Results**

Ensure that all binning results are properly organized and accessible:

.. code-block:: bash

   # Create a directory for DAStool results
   dt_output_dir="bins/dastool"
   mkdir -p "${dt_output_dir}"

   # Ensure you have the contig-to-bin mappings for each binner
   # For example, contig_bins.tsv files in each binner's output directory

**Questions**

- **Q1:** Why is it beneficial to combine results from multiple binners?
- **Q2:** How does DAStool integrate different binning results?

Task 2: Run DAStool
-------------------

**Step 1: Execute DAStool**

Run DAStool using the binning results from MetaDecoder, MetaBAT2, and SemiBin2:

.. code-block:: bash

   DAS_Tool \
     -i bins/metadecoder/contig_bins.tsv,bins/metabat2/contig_bins.tsv,bins/semibin2/contig_bins.tsv \
     -l metadecoder,metabat2,semibin2 \
     -c "${assembly}" \
     -o "${dt_output_dir}/dastool" \
     --write_bins \
     --threads "${threads}"

   # Move contig to bin mapping file for clarity
   mv "${dt_output_dir}/dastool_DASTool_contig2bin.tsv" "${dt_output_dir}/contig_bins.tsv"

**Step 2: Inspect DAStool Output**

List the refined bins:

.. code-block:: bash

   ls -lh "${dt_output_dir}/dastool_DASTool_bins"

**Questions**

- **Q3:** How many bins did DAStool produce?
- **Q4:** How do these bins compare to the individual binner outputs?

Task 3: Assess Bin Quality with CheckM2
---------------------------------------

In this task, you will use CheckM2 to assess the completeness and contamination of the bins produced by each binner and the refiner. We will use `checkm2 predict` command.

**Step 1: Set Up CheckM2 Database Path**

Assuming you have the database at a shareable path, set the database path in an environment variable or specify it directly in the command.

Set the `CHECKM2DB` environment variable:

.. code-block:: bash

   # CheckM2 database path
   checkm2_db_path="${course_data_path}/checkm2_db/CheckM2_database"

   # Move it to session path
   rsync -avP "${checkm2_db_path}" "${session_path}/mag_practical"

   export CHECKM2DB="${session_path}/CheckM2_database/uniref100.KO.1.dmnd"

**Step 3: Run CheckM2 on All Binner/Refiner Outputs**

Create directories for CheckM2 outputs and run `checkm2 predict` for each set of bins.

.. code-block:: bash

   # We need a separate environment for CheckM2
   checkm2_env_path="${course_path}/envs/checkm2_env"

   # Define the list of binners and the refiner
   binners=("metadecoder" "metabat2" "semibin2" "dastool")

   # Loop over each binner and run CheckM2
   for binner in "${binners[@]}"; do
     echo "Running CheckM2 on ${binner} bins..."
     if [ "${binner}" == "dastool" ]; then
       bins_dir="${dt_output_dir}/dastool_DASTool_bins"
       extension="fa"
     elif [ "${binner}" == "metadecoder" ]; then
       bins_dir="bins/metadecoder"
       extension="fasta"
     elif [ "${binner}" == "metabat2" ]; then
       bins_dir="bins/metabat2"
       extension="fa"
     elif [ "${binner}" == "semibin2" ]; then
       bins_dir="bins/semibin2/output_bins"
       extension="fa"
     fi
     checkm2_output_dir="bins/${binner}/checkm2"

     # Ensure out dir is empty
     rm -rf "${checkm2_output_dir}"

     mkdir -p "${checkm2_output_dir}"
     
     conda run -p "${checkm2_env_path}" \
      checkm2 predict \
         --threads "${threads}" \
         --input "${bins_dir}" \
         --output-directory "${checkm2_output_dir}"\
         -x "${extension}"
   done

**Step 4: View CheckM2 Summaries**

Display the bin quality summaries for each binner:

.. code-block:: bash

   for binner in "${binners[@]}"; do
     echo "CheckM2 results for ${binner}:"
     checkm2_output_dir="bins/${binner}/checkm2"
     cat "${checkm2_output_dir}/checkm2_results.tsv"
     echo "--------------------------------------------"
   done

**Questions**

- **Q5:** Which binner produced bins with the highest completeness and lowest contamination?
- **Q6:** Did DAStool improve bin quality compared to individual binners?
- **Q7:** How significant is the improvement provided by DAStool?

**Notes**

- CheckM2 provides estimates of genome completeness and contamination using advanced machine learning models.
- High-quality bins typically have completeness >90% and contamination <5%.

Task 4: Interpret the Results
-----------------------------

**Step 1: Analyze Bin Statistics**

- **Q8:** Are there bins with high completeness but also high contamination? What might cause this?
- **Q9:** How does the choice of binning tool affect the quality of the recovered genomes?

**Step 2: Consider Biological Implications**

- **Q10:** Why is it important to have high-quality bins in metagenomic analyses?
- **Q11:** How might bin quality affect downstream analyses such as functional annotation or comparative genomics?
